<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Haxla RPG</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system}
#game{max-width:420px;margin:auto}
.menu{display:flex;background:#061a2a}
.menu button{flex:1;border:none;background:#061a2a;color:#9cf;padding:8px}
.menu button.active{background:#0e2a42}
.screen{display:none}
.screen.active{display:block}

.dungeon{height:220px;background:#111;
display:flex;flex-direction:column;align-items:center;justify-content:center}
.enemy-img{width:72px;height:72px;border-radius:50%}
.party{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;padding:4px}
.chara{background:#0e2a42;padding:6px;font-size:10px;text-align:center}
.hp{height:6px;background:#333;border-radius:3px}
.hp span{display:block;height:100%;background:#4f9}
.log{height:80px;overflow:auto;font-size:10px;background:#020e18;padding:4px}
.panel{padding:6px}
button{margin:2px}
</style>
</head>

<body>
<div id="game">

<div class="menu">
<button class="active" onclick="show('dungeon')">ダンジョン</button>
<button onclick="show('base')">拠点</button>
</div>

<!-- ダンジョン -->
<div id="dungeon" class="screen active">
<div class="dungeon">
<div id="enemyName"></div>
<div id="enemyHp"></div>
</div>
<div class="party" id="battleParty"></div>
<div class="log" id="log"></div>
</div>

<!-- 拠点 -->
<div id="base" class="screen">
<div class="panel">
<h4>前衛</h4>
<div id="front"></div>
<h4>控え</h4>
<div id="back"></div>
</div>
</div>

</div>

<script>
/* ===== 共通 ===== */
function num(v,d=0){return Number.isFinite(v)?v:d}
function log(t){
const l=document.getElementById("log");
l.innerHTML+=t+"<br>";
l.scrollTop=l.scrollHeight;
}

/* ===== キャラ定義 ===== */
const CHARACTERS=[
{
name:"クローディア",
lv:1,exp:0,
base:{hp:80,atk:12,def:6,tech:8},
growth:{hp:1.1,atk:1.3,def:1.0,tech:1.2},
equip:{weapon:null,armor:null,acc:null}
},
{
name:"アヤメ",
lv:1,exp:0,
base:{hp:65,atk:14,def:4,tech:12},
growth:{hp:1.0,atk:1.2,def:0.9,tech:1.4},
equip:{weapon:null,armor:null,acc:null}
},
{
name:"ベアトリクス",
lv:1,exp:0,
base:{hp:90,atk:9,def:8,tech:6},
growth:{hp:1.2,atk:1.0,def:1.3,tech:0.9},
equip:{weapon:null,armor:null,acc:null}
}
];

/* ===== 状態 ===== */
let state=JSON.parse(localStorage.getItem("save"))||{
front:[0,1,2],
back:[],
chars:JSON.parse(JSON.stringify(CHARACTERS)),
enemy:null
};

/* ===== 敵 ===== */
function createEnemy(){
return {
name:"スライム",
maxHp:50,
hp:50,
atk:6
};
}

/* ===== UI ===== */
function show(id){
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

function calcStat(c){
return {
hp: Math.floor(c.base.hp + c.lv*10),
atk: Math.floor(c.base.atk * c.growth.atk),
def: Math.floor(c.base.def * c.growth.def),
tech: Math.floor(c.base.tech * c.growth.tech)
};
}

/* ===== 描画 ===== */
function render(){
if(!state.enemy)state.enemy=createEnemy();

document.getElementById("enemyName").textContent=state.enemy.name;
document.getElementById("enemyHp").textContent=
`HP ${state.enemy.hp}/${state.enemy.maxHp}`;

const bp=document.getElementById("battleParty");
bp.innerHTML="";
state.front.forEach(i=>{
const c=state.chars[i];
const st=calcStat(c);
bp.innerHTML+=`
<div class="chara">
${c.name} Lv${c.lv}
<div class="hp"><span style="width:${st.hp?100:0}%"></span></div>
ATK ${st.atk} DEF ${st.def} TEC ${st.tech}
</div>`;
});

save();
}

function save(){
localStorage.setItem("save",JSON.stringify(state));
}

/* ===== 戦闘 ===== */
function tick(){
let totalDmg=0;
state.front.forEach(i=>{
const c=state.chars[i];
const st=calcStat(c);
let dmg=st.atk;
const crit=Math.random()<st.tech/100;
if(crit){dmg*=2}
totalDmg+=dmg;
log(`${c.name}の攻撃 → ${dmg}${crit?" (CRIT)":""}`);
});
state.enemy.hp-=totalDmg;
if(state.enemy.hp<=0){
log("敵を撃破！");
state.enemy=createEnemy();
}
render();
}

render();
setInterval(tick,1500);
</script>
</body>
</html>