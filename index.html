<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Haxla RPG</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system}
#game{max-width:420px;margin:auto}
.top{display:flex;align-items:center;padding:6px;background:#0b2a44}
.circle{width:64px;height:64px;border-radius:50%;background:#123}
.menu{display:flex;background:#061a2a}
.menu button{flex:1;border:none;background:#061a2a;color:#9cf;padding:8px}
.menu button.active{background:#0e2a42}
.screen{display:none}
.screen.active{display:block}
.dungeon{height:220px;background:radial-gradient(#222,#000);
display:flex;flex-direction:column;align-items:center;justify-content:center}
.enemy-img{width:72px;height:72px;border-radius:50%;
animation:spawn .3s ease}
.enemy-img.hit{animation:hit .15s}
.enemy-img.dead{animation:dead .4s forwards}
@keyframes spawn{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes hit{0%{transform:translateX(-4px)}50%{transform:translateX(4px)}}
@keyframes dead{to{transform:scale(0);opacity:0}}
.party{display:grid;grid-template-columns:repeat(5,1fr);gap:2px;padding:4px}
.chara{background:#0e2a42;padding:4px;font-size:9px;text-align:center}
.hp{height:6px;background:#333;border-radius:3px}
.hp span{display:block;height:100%;background:#4f9}
.log{height:60px;overflow:auto;font-size:10px;background:#020e18;padding:4px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);
display:none;align-items:center;justify-content:center}
.modal.active{display:flex}
.box{background:#123;padding:12px;width:80%}
</style>
</head>

<body>
<div id="game">
<div class="top"><div id="info"></div></div>

<div class="menu">
<button class="active" onclick="show('dungeon')">ダンジョン</button>
<button onclick="show('town')">拠点</button>
</div>

<div id="dungeon" class="screen active">
<div class="dungeon">
<div id="enemyImg" class="enemy-img"></div>
<div id="enemyName"></div>
<div id="enemyHp"></div>
</div>
<div class="party" id="party"></div>
<div class="log" id="log"></div>
</div>

<div id="town" class="screen">
<button onclick="heal()">全回復</button>
<button onclick="nextFloor()">次の階層</button>
</div>
</div>

<div class="modal" id="modal" onclick="closeModal()">
<div class="box" id="modalBox"></div>
</div>

<script>
function num(v,d=0){return Number.isFinite(v)?v:d}
const state=JSON.parse(localStorage.getItem("save"))||{
floor:1,maxFloor:1,dist:0,
party:[
{name:"クローディア",lv:1,exp:0,hp:100,max:100,atk:10,def:5,eq:null},
{name:"アヤメ",lv:1,exp:0,hp:80,max:80,atk:14,def:3,eq:null}
],
enemy:null
};

const ENEMY={name:"スライム",hp:60,max:60,atk:5,color:"#3af"};

function save(){localStorage.setItem("save",JSON.stringify(state))}

function show(id){
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
}

function spawn(){
state.enemy=JSON.parse(JSON.stringify(ENEMY));
}

function log(t){
const l=document.getElementById("log");
l.innerHTML+=t+"<br>";
l.scrollTop=l.scrollHeight;
}

function tick(){
if(!state.enemy)spawn();
let dmg=0;
state.party.forEach(c=>{
if(Math.random()<0.2){log(c.name+"のクリティカル！");dmg+=c.atk*2}
else dmg+=c.atk
});
state.enemy.hp-=dmg;
document.getElementById("enemyImg").classList.add("hit");

if(state.enemy.hp<=0){
log("敵を撃破！");
state.dist++;
if(state.dist>=5){state.maxFloor=state.floor}
spawn();
}
render();
}

function render(){
document.getElementById("info").textContent=`${state.floor}F ${state.dist}m`;
document.getElementById("enemyName").textContent=state.enemy.name;
document.getElementById("enemyHp").textContent=`HP ${state.enemy.hp}/${state.enemy.max}`;
const img=document.getElementById("enemyImg");
img.style.background=state.enemy.color;

const p=document.getElementById("party");
p.innerHTML="";
state.party.forEach((c,i)=>{
const rate=Math.max(0,Math.min(100,Math.floor(num(c.hp)/num(c.max)*100)));
p.innerHTML+=`
<div class="chara" onclick="detail(${i})">
${c.name} Lv${c.lv}
<div class="hp"><span style="width:${rate}%"></span></div>
</div>`;
});
save();
}

function heal(){state.party.forEach(c=>c.hp=c.max);render()}
function nextFloor(){
if(state.floor>=state.maxFloor){state.floor++;state.dist=0;spawn();render()}
}

function detail(i){
const c=state.party[i];
document.getElementById("modalBox").innerHTML=
`<b>${c.name}</b><br>Lv${c.lv}<br>HP ${c.hp}/${c.max}<br>ATK ${c.atk}<br>DEF ${c.def}`;
document.getElementById("modal").classList.add("active");
}
function closeModal(){document.getElementById("modal").classList.remove("active")}

render();
setInterval(tick,1000);
</script>
</body>
</html>