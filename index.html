<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Haxla RPG</title>

<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
#game{max-width:420px;margin:auto}

/* ä¸Šéƒ¨ */
.top{display:flex;align-items:center;padding:6px;background:#0b2a44}
.circle{width:64px;height:64px;border-radius:50%;background:linear-gradient(#1e4f7a,#0b2a44);
display:flex;align-items:center;justify-content:center;font-size:12px;text-align:center}
.bar{flex:1;height:30px;margin:0 6px;background:#143b63;border-radius:4px}
.icons{font-size:12px;opacity:.8}

/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.menu{display:flex;background:#061a2a}
.menu button{flex:1;border:none;background:#061a2a;color:#9cf;padding:8px}
.menu button.active{background:#0e2a42}

/* ç”»é¢ */
.screen{display:none}
.screen.active{display:block}

/* ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ */
.dungeon{height:260px;background:radial-gradient(#222,#000);display:flex;align-items:center;justify-content:center}
.enemy{color:#ff6666;font-size:16px}

/* ãƒ‘ãƒ¼ãƒ†ã‚£ */
.party{display:grid;grid-template-columns:repeat(5,1fr);gap:2px;padding:4px;background:#061a2a}
.chara{background:#0e2a42;padding:4px;font-size:9px;text-align:center}
.face{width:36px;height:36px;border-radius:50%;background:linear-gradient(#666,#222);margin:0 auto 2px}
.hp-bar{height:6px;background:#333;border-radius:3px;overflow:hidden}
.hp-bar span{display:block;height:100%;background:linear-gradient(#4eff9a,#1fae63)}
.skill{font-size:8px;color:#9cf}

/* æ‹ ç‚¹ãƒ»è–æ¯ */
.panel{padding:20px;text-align:center}
.panel button{padding:10px;margin:6px;border:none;background:#0e2a42;color:#fff}
</style>
</head>

<body>
<div id="game">

<!-- ä¸Šéƒ¨ -->
<div class="top">
  <div class="circle">
    <div>
      <div id="floor">1F</div>
      <div id="dist">0m</div>
    </div>
  </div>
  <div class="bar"></div>
  <div class="icons">â–¶â–¶ ğŸ”Š è‡ªå‹•</div>
</div>

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="menu">
  <button id="btn-dungeon" class="active" onclick="show('dungeon')">ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</button>
  <button id="btn-town" onclick="show('town')">æ‹ ç‚¹</button>
  <button id="btn-holy" onclick="show('holy')">è–æ¯</button>
</div>

<!-- ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ -->
<div id="dungeon" class="screen active">
  <div class="dungeon">
    <div class="enemy" id="enemy">æ¢ç´¢ä¸­â€¦</div>
  </div>
  <div class="party" id="party"></div>
</div>

<!-- æ‹ ç‚¹ -->
<div id="town" class="screen">
  <div class="panel">
    <p>é¨å£«å›£æœ¬éƒ¨</p>
    <button onclick="heal()">å…¨å›å¾©</button>
  </div>
</div>

<!-- è–æ¯ -->
<div id="holy" class="screen">
  <div class="panel">
    <p>è–æ¯pt: <span id="holyPt">0</span></p>
    <p>æ”»æ’ƒå€ç‡: x<span id="atkMul">1.00</span></p>
    <p>HPå€ç‡: x<span id="hpMul">1.00</span></p>
    <button onclick="upAtk()">æ”»æ’ƒå¼·åŒ–</button>
    <button onclick="upHp()">HPå¼·åŒ–</button>
  </div>
</div>

</div>

<script>
/* ========= å®‰å…¨ãªåˆæœŸå®šç¾© ========= */
const DEFAULT_PARTY = [
  {name:"ã‚¯ãƒ­ãƒ¼ãƒ‡ã‚£ã‚¢",hp:2984,max:2984,lv:1,skill:"å…ˆé™£"},
  {name:"ã‚¢ãƒ¤ãƒ¡",hp:2117,max:2117,lv:1,skill:"å½±æ–¬ã‚Š"},
  {name:"ãƒ™ã‚¢ãƒˆãƒªã‚¯ã‚¹",hp:2631,max:2631,lv:1,skill:"ç¥ˆã‚Š"},
  {name:"ãƒ‰ã‚¥ãƒ¼ã‚¬ãƒ«ãƒ‰",hp:2362,max:2362,lv:1,skill:"é‰„å£"},
  {name:"ã‚«ãƒ«ãƒ­ã‚¹",hp:2323,max:2323,lv:1,skill:"æ¿€æ˜‚"}
];

/* ========= ã‚»ãƒ¼ãƒ–èª­ã¿è¾¼ã¿ï¼ˆå£Šã‚Œã¦ã¦ã‚‚ä¿®å¾©ï¼‰ ========= */
function loadState(){
  let raw = {};
  try{ raw = JSON.parse(localStorage.getItem("save")) || {}; }catch(e){}
  const now = Date.now();

  const state = {
    dist: Number(raw.dist)||0,
    floor: Number(raw.floor)||1,
    enemyHp: Number(raw.enemyHp)||300,
    last: Number(raw.last)||now,
    holy: Number(raw.holy)||0,
    permAtk: Number(raw.permAtk)||1,
    permHp: Number(raw.permHp)||1,
    party: []
  };

  const srcParty = Array.isArray(raw.party) ? raw.party : [];
  for(let i=0;i<DEFAULT_PARTY.length;i++){
    const d = DEFAULT_PARTY[i];
    const s = srcParty[i]||{};
    state.party.push({
      name: d.name,
      skill: d.skill,
      lv: Number(s.lv)||d.lv,
      max: Number(s.max)||d.max,
      hp: Math.min(Number(s.hp)||d.max, Number(s.max)||d.max)
    });
  }

  return state;
}

let state = loadState();

/* ========= ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€²è¡Œ ========= */
const now = Date.now();
const diff = Math.floor((now - state.last)/1000);
if(diff>0){
  state.dist += diff;
  state.holy += Math.floor(diff/60);
}
state.last = now;

/* ========= UI ========= */
const enemyDiv = document.getElementById("enemy");
const partyDiv = document.getElementById("party");

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".menu button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+id).classList.add("active");
}

function render(){
  document.getElementById("dist").textContent = state.dist+"m";
  document.getElementById("floor").textContent = state.floor+"F";
  document.getElementById("holyPt").textContent = state.holy;
  document.getElementById("atkMul").textContent = state.permAtk.toFixed(2);
  document.getElementById("hpMul").textContent = state.permHp.toFixed(2);

  partyDiv.innerHTML="";
  state.party.forEach(c=>{
    const el=document.createElement("div");
    el.className="chara";
    el.innerHTML=`
      <div class="face"></div>
      ${c.name}
      <div class="hp-bar"><span style="width:${(c.hp/c.max)*100}%"></span></div>
      <div class="skill">${c.skill} Lv${c.lv}</div>
    `;
    partyDiv.appendChild(el);
  });

  localStorage.setItem("save",JSON.stringify(state));
}

/* ========= è–æ¯ ========= */
function upAtk(){ if(state.holy>0){ state.holy--; state.permAtk+=0.1; render(); } }
function upHp(){ if(state.holy>0){ state.holy--; state.permHp+=0.1; render(); } }

/* ========= æ‹ ç‚¹ ========= */
function heal(){ state.party.forEach(c=>c.hp=c.max); render(); }

/* ========= ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ========= */
function tick(){
  state.dist++;
  state.floor = Math.floor(state.dist/100)+1;

  let dmg = 25*state.permAtk;
  state.party.forEach(c=>{
    if(c.skill==="å…ˆé™£") dmg*=1+0.1*c.lv;
    if(c.skill==="å½±æ–¬ã‚Š" && Math.random()<0.1*c.lv) dmg*=2;
    if(c.skill==="ç¥ˆã‚Š") c.hp=Math.min(c.max,c.hp+4*c.lv);
    if(c.skill==="æ¿€æ˜‚") dmg*=1+(1-c.hp/c.max);
  });

  state.enemyHp -= dmg;
  if(state.enemyHp<=0){
    state.enemyHp = (state.dist%100===0) ? 3000+state.floor*500 : 300+state.floor*60;
    state.holy++;
  }

  enemyDiv.textContent = (state.dist%100===0?"BOSS ":"")+"æ•µ HP "+Math.floor(state.enemyHp);

  const t = state.party[Math.floor(Math.random()*state.party.length)];
  let taken = 15*state.floor;
  if(t.skill==="é‰„å£") taken*=1-0.1*t.lv;
  t.hp -= taken;

  if(state.party.every(c=>c.hp<=0)){
    state.party.forEach(c=>{
      c.max=Math.floor(c.max*(1+state.permHp*0.1));
      c.hp=c.max;
    });
    state.permAtk+=state.holy*0.01;
    state.holy=0;
  }

  if(state.dist%200===0) state.party.forEach(c=>c.lv++);
  render();
}

render();
setInterval(tick,1000);
</script>
</body>
</html>